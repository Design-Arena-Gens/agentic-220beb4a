'use client';
import { useEffect, useRef, useState } from 'react';

export default function Page() {
  const [isRoaring, setIsRoaring] = useState(false);
  const [step, setStep] = useState(0);
  const audioCtxRef = useRef(null);
  const gainRef = useRef(null);

  useEffect(() => {
    return () => {
      if (audioCtxRef.current) {
        audioCtxRef.current.close();
      }
    };
  }, []);

  const playRoar = async () => {
    try {
      if (!audioCtxRef.current) {
        audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
      }
      const ctx = audioCtxRef.current;
      const osc = ctx.createOscillator();
      const noise = ctx.createBufferSource();
      const buffer = ctx.createBuffer(1, ctx.sampleRate * 1.2, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < data.length; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 2);
      }
      noise.buffer = buffer;

      const gain = ctx.createGain();
      gain.gain.value = 0.001;
      gainRef.current = gain;

      osc.type = 'sawtooth';
      osc.frequency.value = 70;

      const lfo = ctx.createOscillator();
      lfo.frequency.value = 4;
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 40;
      lfo.connect(lfoGain).connect(osc.frequency);

      const filter = ctx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 800;

      osc.connect(filter);
      noise.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);

      const now = ctx.currentTime;
      const ramp = gain.gain;
      ramp.cancelScheduledValues(now);
      ramp.setValueAtTime(0.0001, now);
      ramp.exponentialRampToValueAtTime(0.6, now + 0.1);
      ramp.exponentialRampToValueAtTime(0.0001, now + 1.1);

      setIsRoaring(true);
      osc.start();
      noise.start();
      lfo.start();

      setTimeout(() => {
        try {
          osc.stop();
          noise.stop();
          lfo.stop();
        } catch {}
        setIsRoaring(false);
      }, 1150);
    } catch (e) {
      // noop
    }
  };

  const steps = [
    '???? ????, ????? ???? ?????? ??? ??? ???? ???????? ???? ????? ??? ???? ?? ?? ????? ??-????? ?????? ?????',
    '???? ?? ???, ??? ??? ?? ??? ?????',
    '????! ??? ???? ????? ?? ????? ?? ???? ????? ?? ??? ???? ???? ??-????? ????? ?? ?????? ? ?? ???? ??? ??????',
    '???? ???, ?????? ?? ?? ?? ? ???? ??? ???? ??? ?????!?',
    '???? ?? ??????? ?? ????? ?? ???? ??-????? ?????? ??? ?? ??-?????, ???? ??? ? ? ???? ?? ??? ???? ?????? ?????? ??? ??? ?? ?????, ??????',
    '????, ????? ???? ?? ? ????? ???????? ??? ?? ??-????? ???? ??!?',
    '???? ????! ?? ?? ????? ???? ?????? ??? ????',
    '??? ????? ??? ?? ??-????? ?? ????-???? ???????? ??? ?? ?? ????? ??? ????? ???? ????',
  ];

  return (
    <main className="container">
      <header className="header">
        <h1>??-????? ?? ?????</h1>
        <p className="tag">?? ?????? ???????? ??????</p>
      </header>

      <section className="stage">
        <div className={`trex ${isRoaring ? 'roar' : ''}`} aria-hidden>
          <svg viewBox="0 0 256 128" width="320" height="160" role="img">
            <title>????????</title>
            <g fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
              <path d="M12 92 C 28 76, 58 68, 98 70 C 146 74, 190 72, 236 74" />
              <circle cx="74" cy="44" r="10" fill="currentColor" />
              <path d="M64 52 l 24 8" />
              <path d="M110 84 l -8 20 M146 86 l 10 20" />
              <path d="M52 60 q 24 -14 48 -10 q 28 6 44 0 q 24 -10 32 -4 q 10 6 10 16 q -2 12 -18 16 q -16 4 -38 2 q -22 -2 -40 -6 q -18 -4 -38 -14 z" fill="currentColor" opacity="0.15" />
              <path d="M68 40 q 8 -6 16 0" />
              <circle cx="88" cy="38" r="2" fill="currentColor" />
              <path d="M116 60 q 6 -2 10 0" />
            </g>
          </svg>
        </div>
        <button className="btn" onClick={playRoar}>
          {isRoaring ? '????? ??? ???' : '???????? ?? ????? ?????'}
        </button>
      </section>

      <section className="story">
        {steps.map((line, idx) => (
          <p key={idx} className={idx === step ? 'active' : ''}>
            {line}
          </p>
        ))}
      </section>

      <nav className="nav">
        <button className="btn secondary" onClick={() => setStep((s) => Math.max(0, s - 1))} disabled={step === 0}>
          ?????
        </button>
        <div className="progress" aria-label="??????">
          <div className="bar" style={{ width: `${((step + 1) / steps.length) * 100}%` }} />
        </div>
        <button className="btn" onClick={() => setStep((s) => Math.min(steps.length - 1, s + 1))} disabled={step === steps.length - 1}>
          ????
        </button>
      </nav>

      <footer className="footer">? {new Date().getFullYear()} ?????? ??? ????????</footer>
    </main>
  );
}
